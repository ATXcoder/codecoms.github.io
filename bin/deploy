#!/usr/bin/env bash

usage() {
  echo "$( basename $0 ) <local|digicat>" 1>&2
  exit 1
}

run_docker() {
  label=$1; shift
  docker run \
    --rm \
    --interactive \
    --tty \
    --label=jekyll \
    --env="BUNDLE_CACHE=true" \
    --volume=$(pwd):/srv/jekyll \
    jekyll/jekyll \
    "$@"
}

run_docker_listen() {
  label=$1; shift
  docker run \
    --rm \
    --interactive \
    --tty \
    --label=jekyll \
    --env="BUNDLE_CACHE=true" \
    --volume=$(pwd):/srv/jekyll \
    --publish="127.0.0.1:4000:4000" \
    jekyll/jekyll \
    "$@"
}

BASEDIR=$( readlink -f $( dirname $0 )/.. )

run_local() {
  cid=$( docker ps -q --filter="label=jekyll-local" )

  [[ -n $cid ]] && docker stop --time=1 $cid

  run_docker_listen jekyll bundle exec jekyll serve --watch
}

run_digicat() {
  run_docker jekyll-build bundle exec jekyll build \
    && rsync -rv --exclude /static --delete _site/ nezumi:public_html/
}

cd $BASEDIR

case $1 in
  local) run_local;;
  digicat) run_digicat;;
  *) usage;;
esac
